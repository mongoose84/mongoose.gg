# .github/workflows/deploy-api.yml
name: Server - ASP .NET API CI & Deploy

# -------------------------------------------------
# When to run
# -------------------------------------------------
on:
  push:
    branches: [main]
    paths:
      - 'server/**'          # only trigger when API code changes
  workflow_dispatch:         # manual trigger from the UI

# -------------------------------------------------
# Job definition
# -------------------------------------------------
jobs:
  build-and-deploy:
    runs-on: windows-latest               # needed for win‑x86 runtime
    env:
      # Folder where `dotnet publish` will drop the files
      PUBLISH_DIR: publish-output  
      
    defaults:
      # Every `run:` step will start in the project folder
      run:
        working-directory: server

    steps:
      # -------------------------------------------------
      # Checkout the repo
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for versioning tools


      # --------------------------------------------------------------
      #  Copy the app_offline.htm from the support folder to the main folder
      # --------------------------------------------------------------
      - name: Bring site offline (copy app_offline.htm on server)
        shell: pwsh
        run: |
          curl -v --ssl -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" `
            "ftp://${{ secrets.FTP_URL }}" `
            -Q "RNFR ${{ secrets.FTP_SERVER_PATH }}/CI-Support/app_offline.htm" `
            -Q "RNTO ${{ secrets.FTP_SERVER_PATH }}/app_offline.htm"
          

      # -------------------------------------------------
      # Set up .NET SDK
      # -------------------------------------------------
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'          # matches TargetFramework net9.0

      # -------------------------------------------------
      # Restore NuGet packages (optional but clearer logs)
      # -------------------------------------------------
      - name: Restore dependencies
        run: dotnet restore

      # -------------------------------------------------
      # Validate required secrets are set
      # -------------------------------------------------
      - name: Validate required secrets
        shell: pwsh
        run: |
          $missingSecrets = @()
          
          if ([string]::IsNullOrWhiteSpace("${{ secrets.LOL_DB_CONNECTIONSTRING }}")) {
            $missingSecrets += "LOL_DB_CONNECTIONSTRING"
          }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.LOL_DB_CONNECTIONSTRING_V2 }}")) {
            $missingSecrets += "LOL_DB_CONNECTIONSTRING_V2"
          }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.RIOT_API_KEY }}")) {
            $missingSecrets += "RIOT_API_KEY"
          }
          
          if ($missingSecrets.Count -gt 0) {
            Write-Error "❌ Missing required GitHub secrets: $($missingSecrets -join ', ')"
            Write-Error "Please add these secrets in: Settings → Secrets and variables → Actions"
            Write-Error "Required format:"
            Write-Error "  - LOL_DB_CONNECTIONSTRING: Server=host;Port=3306;Database=db;User=user;Password=pass"
            Write-Error "  - LOL_DB_CONNECTIONSTRING_V2: Server=host;Port=3306;Database=db_v2;User=user;Password=pass"
            Write-Error "  - RIOT_API_KEY: RGAPI-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
            exit 1
          }
          
          Write-Host "✅ All required secrets are configured"

      # -------------------------------------------------
      # Create appsettings.Production.json with secrets
      # This file will be deployed and read by the app at runtime
      # -------------------------------------------------
      - name: Generate appsettings.Production.json
        shell: pwsh
        run: |
          $json = @{
            "Logging" = @{
              "LogLevel" = @{
                "Default" = "Warning"
                "Microsoft.AspNetCore" = "Warning"
              }
            }
            "AllowedHosts" = "*"
            "ConnectionStrings" = @{
              "Default" = "${{ secrets.LOL_DB_CONNECTIONSTRING }}"
              "DatabaseV2" = "${{ secrets.LOL_DB_CONNECTIONSTRING_V2 }}"
            }
            "Riot" = @{
              "ApiKey" = "${{ secrets.RIOT_API_KEY }}"
            }
            "Auth" = @{
              "CookieName" = "pulse-auth"
              "SessionTimeout" = 30
              "EnableMvpLogin" = $false
            }
            "Jobs" = @{
              "EnableMatchHistorySync" = $true
            }
          } | ConvertTo-Json -Depth 10
          
          Set-Content -Path "appsettings.Production.json" -Value $json
          Write-Host "✅ appsettings.Production.json generated successfully (contents hidden for security)"

      # -------------------------------------------------
      # Run server unit tests (including auth hardening)
      # -------------------------------------------------
      - name: Run tests
        run: dotnet test ../lol.sln --configuration Release --logger "trx;LogFileName=test-results.trx"

      # -------------------------------------------------
      # Publish a **self‑contained** Windows‑x86 binary
      # -------------------------------------------------
      - name: Publish (self-contained)
        run: |
          dotnet publish -c Release -r win-x86 --self-contained=true  -o ./${{ env.PUBLISH_DIR }}
      
      # -------------------------------------------------
      # Verify publish output exists and show its contents
      # -------------------------------------------------
      - name: Verify publish output
        shell: pwsh
        run: |
          if (-not (Test-Path "./${{ env.PUBLISH_DIR }}")) {
            Write-Error "Publish output folder './${{ env.PUBLISH_DIR }}' not found"
            exit 1
          }
          Write-Host "=== Files that will be uploaded ==="
          Get-ChildItem -Recurse "./${{ env.PUBLISH_DIR }}"

      # -------------------------------------------------
      # Deploy new files via FTPS (publish folder only)
      # -------------------------------------------------
      - name: Deploy new files to FTP server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_URL }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          # Point to the SAME folder we just verified
          local-dir: ./server/${{ env.PUBLISH_DIR }}/
          # NOTE: The exclusion patterns below may be redundant. RiotProxy.csproj already
          # excludes RiotProxy.Tests content via Compile Remove, EmbeddedResource Remove,
          # and None Remove directives. Since the tests project is separate and should not
          # be included in the publish output by dotnet publish, these FTP patterns are
          # likely unnecessary. Consider removing if verification confirms test files are
          # not present in the publish folder.
          exclude: |
            RiotProxy.Tests/**
            **/RiotProxy.Tests/**
          server-dir: ${{ secrets.FTP_SERVER_PATH }}
          # optional safety flags
          # dry-run: false
          # timeout: 30

       # --------------------------------------------------------------
      # Bring site back online (move the app_offline.htm to the support folder)
      # --------------------------------------------------------------
      - name: Bring site back online (delete app_offline.htm)
        shell: pwsh
        run: |
          curl -v --ssl -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" `
            "ftp://${{ secrets.FTP_URL }}" `
            -Q "RNFR ${{ secrets.FTP_SERVER_PATH }}/app_offline.htm" `
            -Q "RNTO ${{ secrets.FTP_SERVER_PATH }}/CI-Support/app_offline.htm"

